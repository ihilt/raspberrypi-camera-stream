#!/usr/bin/env python
from dotenv import load_dotenv
from subprocess import Popen, PIPE
import os

load_dotenv(dotenv_path='/home/pi/.env')
STREAM_ID=os.getenv('STREAM_ID')

cmd = ['avconv', '-loglevel', 'panic', '-re', '-ar', '44100', '-ac', '2', '-acodec', 'pcm_s16le', '-f', 's16le', '-ac', '2', '-i', '/dev/zero', '-f', 'h264', '-i', '-', '-vcodec', 'copy', '-acodec', 'aac', '-ab', '128k', '-g', '50', '-strict', 'experimental', '-f', 'flv', 'rtmp://a.rtmp.youtube.com/live2/$STREAM_ID']

p1 = Popen(['/usr/bin/raspivid', '-o', '-', '-t', '0', '-vf', '-hf', '-fps', '30', '-b', '6000000'], stdout=PIPE)
p2 = Popen(['avconv', '-loglevel', 'panic', '-re', '-ar', '44100', '-ac', '2', '-acodec', 'pcm_s16le', '-f', 's16le', '-ac', '2', '-i', '/dev/zero', '-f', 'h264', '-i', '-', '-vcodec', 'copy', '-acodec', 'aac', '-ab', '128k', '-g', '50', '-strict', 'experimental', '-f', 'flv', 'rtmp://a.rtmp.youtube.com/live2/' + STREAM_ID], stdin=p1.stdout, stdout=PIPE)
p1.stdout.close()
output = p2.communicate()[0]
